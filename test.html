<!-- Example index.html Copyright (C) BBC Research & Development - content used with kind permission of Ian Forrester https://twitter.com/cubicgarden/ -->
<!-- Version 2.1 -->

<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Hyperaudio - BBCRD | Education | Ethics of personal data in the era of QS and IoT</title>
  <link rel="stylesheet" href="css/hyperaudio-lite-player.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.5.0/velocity.js"></script>
  <style>
    /* uncomment the following CSS for active parent / word indicator */

    .hyperaudio-transcript .active {
      background-color: #efefef;
    }

    .hyperaudio-transcript .active>.active {
      background-color: #ccf;
      text-decoration: #00f underline;
      text-decoration-thickness: 3px;
    }
  </style>
</head>

<body>
  <box style="height: 100vh;box-sizing: border-box;" id="Thebox">
  <p>
  <form id="searchForm" style="float:right;position:static;">
    <!-- comment out the following line if you don't need playback rate controls -->
    Playback Rate <span id="currentPbr">1</span><input id="pbr" type="range" value="1" min="0.5" max="3" step="0.1">
    <!-- Add a file uploader-->
    <span style="border: 1px solid #ccc; padding: 5px; margin: 5px 0">
      <label for="Uploader">Up</label>
      <input id="Uploader" type="file" accept=".json,.mp4" multiple>
    </span>
  </form>
  </p>

  <script>
    function getparams() {
      var params = new URLSearchParams(window.location.search);
      var videoUrl = params.get('video');
      var subtitleUrl = params.get('subtitle');

      if (subtitleUrl) {
        fetch(subtitleUrl)
          .then(response => response.text())
          .then(content => {
            var subtitleType = subtitleUrl.substr(subtitleUrl.lastIndexOf('.'));
            switch (subtitleType) {
              case '.vtt':
                processVTT(content);
                break;
              case '.srt':
                processSRT(content);
                break;
              case '.json':
                processJSON(content);
                break;
              default:
                console.log('Unsupported subtitle format');
                break;
            }
          })
          .catch(error => console.error('Error fetching subtitle:', error));
      }

      if (videoUrl) {
        // sleep 0.5 second to wait for the subtitle to be loaded
        setTimeout(() => {
          processVideo(videoUrl);
        }, 500);
      }
    };

    document.addEventListener('DOMContentLoaded', getparams());
    // window.onresize = updateHeight;

    document.getElementById('Uploader').addEventListener('change', function (e) {
      var files = Array.from(e.target.files).sort((a, b) => b.name.localeCompare(a.name));

      var videoFile, subtitleFile;
      files.forEach(file => {
        if (file.type.startsWith('video/')) {
          videoFile = file;
        } else if (['application/json', 'text/vtt', 'application/x-subrip'].includes(file.type)) {
          subtitleFile = file;
        }
      });

      if (videoFile) {
        processVideo(URL.createObjectURL(videoFile));
      }
      if (subtitleFile) {
        processSubtitles(subtitleFile);
      }
    });

    function processVideo(url) {
      // Create a new section element
      var newSection = document.createElement('section');
      newSection.setAttribute('data-media-src', url);

      // Get the article element
      var articleElement = document.querySelector('article');

      // Insert the new section at the top of the article
      articleElement.insertBefore(newSection, articleElement.firstChild);

      // Get the video element and set its src attribute
      var videoElement = document.getElementById('hyperplayer');
      videoElement.setAttribute('src', url);

      // Load the video
      videoElement.load();

      // fit height
      // setTimeout(() => {
      //   updateHeight();
      //   }, 2000);
    }

    function insertSubtitles(content) {
      // Get the first section in the article
      var articleElement = document.querySelector('article');
      var firstSection = articleElement.querySelector('section');

      // Insert the subtitles into the first section
      firstSection.innerHTML = content;

      // remove other sections
      var sections = articleElement.querySelectorAll('section');
      for (var i = 1; i < sections.length; i++) {
        sections[i].remove();
      }
    }
  
    function updateHeight() {
      let boxHeight = window.getComputedStyle(document.getElementById('Thebox')).height;
      console.log(boxHeight)
      let formHeight = window.getComputedStyle(document.getElementById('searchForm')).height;
      console.log(formHeight)
      let hyperplayerHeight = window.getComputedStyle(document.getElementById('hyperplayer')).height;
      console.log(hyperplayerHeight)

      let hypertranscriptHeight =  `${parseInt(boxHeight)- parseInt(formHeight) - parseInt(hyperplayerHeight) - 60}px`

      console.log(hypertranscriptHeight)

      document.getElementById('hypertranscript').style.height = hypertranscriptHeight;
    }
  </script>

  <!-- Comment out the following line if you are using an alternative player. ie SoundCloud or YouTube -->
  <video id="hyperplayer" class="hyperaudio-player" style="z-index: 5000000; position:sticky; width:100%" controls>
    <track id="hyperplayer-vtt" label="English" kind="subtitles" srclang="en" src="">
  </video>

  <div id="hypertranscript" class="hyperaudio-transcript"
    style="overflow-y:scroll; flex: auto; min-height: 10px; height:40vh; border-style:dashed; border-width: 1px; border-color:#999; padding: 8px">

    <article data-wm="$ilp.uphold.com/123article">

      <section data-media-src="https://lab.hyperaud.io/video/BBC/education.mp4" data-wm="$ilp.uphold.com/123section">

      </section>
    </article>
  </div>

  <script src="js/hyperaudio-lite.js"></script>
  <script src="js/hyperaudio-lite-extension.js"></script>
  <script src="js/share-this.js"></script>
  <script src="js/share-this-twitter.js"></script>
  <script src="js/share-this-clipboard.js"></script>
  <script src="js/caption.js"></script>
  <script src="js/subtitle.js"></script>
  <script>

    // minimizedMode is still experimental - it aims to show the current words in the title, which can be seen on the browser tab.
    let minimizedMode = false;
    let autoScroll = false;
    let doubleClick = true;
    let webMonetization = false;
    let playOnClick = true;

    // new HyperaudioLite("hypertranscript", "hyperplayer", minimizedMode, autoScroll, doubleClick, webMonetization, playOnClick);

    // Override scroll parameters
    //ht1.setScrollParameters(<duration>, <delay>, <offset>, <container>);

    // this should create captions  
    let cap1 = caption();
    cap1.init("hypertranscript", "hyperplayer", '37', '21'); // transcript Id, player Id, max chars, min chars for caption line

  </script>
  </box>
</body>

</html>