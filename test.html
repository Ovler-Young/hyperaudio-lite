<!-- Example index.html Copyright (C) BBC Research & Development - content used with kind permission of Ian Forrester https://twitter.com/cubicgarden/ -->
<!-- Version 2.1 -->

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Hyperaudio - BBCRD | Education | Ethics of personal data in the era of QS and IoT</title>
  <link rel="stylesheet" href="css/hyperaudio-lite-player.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.5.0/velocity.js"></script>
  <style>
    /* uncomment the following CSS for active parent / word indicator */ 
    
    .hyperaudio-transcript .active{
      background-color: #efefef;
    }

    .hyperaudio-transcript .active > .active {
      background-color: #ccf;
      text-decoration:  #00f underline;
      text-decoration-thickness: 3px;
    }
    
  </style>
  <script src="js/convert-to-hyperaudio.js"></script>
</head>
<body>
  <p>
    <form id="searchForm" style="float:right">
      <!-- comment out the following line if you don't need playback rate controls -->
      Playback Rate <span id="currentPbr">1</span><input id="pbr" type="range" value="1" min="0.5" max="3" step="0.1" style="width:10%">
      <input id="search" type="text" ><input type="submit" value="search">
      <!-- Add a file uploader-->
      <div style="border: 1px solid #ccc; padding: 10px; margin: 10px 0;">
        <label for="jsonUpload">Upload Files:</label>
        <input id="jsonUpload" type="file" accept=".json,.vtt,.srt,.mp4,.avi,.mkv" multiple>
      </div>
    </form>
  </p>

  <script>
    document.getElementById('jsonUpload').addEventListener('change', function(e) {
      var files = Array.from(e.target.files).sort((a, b) => b.name.localeCompare(a.name));
  
      if (files.length === 1) {
        var file = files[0];
        if (file.type.startsWith('video/')) {
          var url = URL.createObjectURL(file);
                
          // Create a new section element
          var newSection = document.createElement('section');
          newSection.setAttribute('data-media-src', url);
                
          // Get the article element
          var articleElement = document.querySelector('article');
                
          // Insert the new section at the top of the article
          articleElement.insertBefore(newSection, articleElement.firstChild);
                
          // Get the video element and set its src attribute
          var videoElement = document.getElementById('hyperplayer');
          videoElement.setAttribute('src', url);

          // Load the video
          videoElement.load();

          // Change the title to include the video name
          document.title = 'Hyperaudio|' + file.name;
        } else {
          var reader = new FileReader();
          reader.onload = function(e) {
            var content = e.target.result;
            var fileName = file.name;
            var subtitleType = fileName.substr(fileName.lastIndexOf('.'));
            switch (subtitleType) {
              case '.vtt':
                console.log('Unsupported subtitle format');
                processVTT(content);
                break;
              case '.srt':
                console.log('Unsupported subtitle format');
                processSRT(content);
                break;
              case '.json':
                processJSON(content);
                break;
              default:
                console.log('Unsupported subtitle format');
                break;
            }
          };
          reader.readAsText(file);
        }
        
      } else if (files.length > 1) {
        // later
      }
    });

    function processVTT(content) {
      // process VTT subtitle file
    }

    function processSRT(content) {
      // process SRT subtitle file
    }

    function processJSON(content) {
      // Parse the JSON content
      const data = JSON.parse(content);
      // Initialize the output string with the opening tags
      let outputString = '<p>start';
      // Initialize the end time of the last word
      let lastEndTime = 0;
      // Iterate over the segments
      for (const segment of data.segments) {
          // Iterate over the words in each segment
          for (const word of segment.words) {
              // If the start time of the current word is more than 2 seconds after the end time of the last word, add a new paragraph
              if (word.start - lastEndTime > 2) {
                  outputString += '</p><p>';
              } else if (word.start - lastEndTime > 0.4) {
                  outputString += `<span data-m="${Math.round(word.start * 1000)}" data-d="400">ï¼Œ</span>`;
              }
              // Add a span element for the current word
              outputString += `<span data-m="${Math.round(word.start * 1000)}" data-d="${Math.round((word.end - word.start) * 1000)}">${/^[a-zA-Z]+$/.test(word.word) ? word.word + ' ' : word.word}</span>`;
              // Update the end time of the last word
              lastEndTime = word.end;
          }
      }
      // Add the closing tags
      outputString += '</p>';
      console.log(outputString);
      insertSubtitles(outputString);
      new HyperaudioLite("hypertranscript", "hyperplayer", minimizedMode, autoScroll, doubleClick, webMonetization, playOnClick);
    }

    function insertSubtitles(content) {
      // Get the first section in the article
      var articleElement = document.querySelector('article');
      var firstSection = articleElement.querySelector('section');

      // Insert the subtitles into the first section
      firstSection.innerHTML = content;
    }
  </script>

  <!-- Comment out the following line if you are using an alternative player. ie SoundCloud or YouTube -->
  <video id="hyperplayer" class="hyperaudio-player" style="z-index: 5000000; position:relative; width:400px" controls>
    <track id="hyperplayer-vtt" label="English" kind="subtitles" srclang="en" src="">
  </video>

  <div id="hypertranscript" class="hyperaudio-transcript" style="overflow-y:scroll; height:600px; position:relative; border-style:dashed; border-width: 1px; border-color:#999; padding: 8px">
    
    <article data-wm="$ilp.uphold.com/123article">

      <section data-media-src="https://lab.hyperaud.io/video/BBC/education.mp4" data-wm="$ilp.uphold.com/123section">

      </section>
    </article>
  </div>
  
  <script src="js/hyperaudio-lite.js"></script>
  <script src="js/hyperaudio-lite-extension.js"></script>
  <script src="js/share-this.js"></script>
  <script src="js/share-this-twitter.js"></script>
  <script src="js/share-this-clipboard.js"></script>
  <script src="js/caption.js"></script>
  <script>

  // minimizedMode is still experimental - it aims to show the current words in the title, which can be seen on the browser tab.
  let minimizedMode = false;
  let autoScroll = true;
  let doubleClick = true;
  let webMonetization = false;
  let playOnClick = true;

  // new HyperaudioLite("hypertranscript", "hyperplayer", minimizedMode, autoScroll, doubleClick, webMonetization, playOnClick);

  // Override scroll parameters
  //ht1.setScrollParameters(<duration>, <delay>, <offset>, <container>);

  // this should create captions  
  let cap1 = caption();
  cap1.init("hypertranscript", "hyperplayer", '37' , '21'); // transcript Id, player Id, max chars, min chars for caption line
  
  </script>
</body>
</html>
