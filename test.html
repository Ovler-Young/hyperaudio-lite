<!-- Example index.html Copyright (C) BBC Research & Development - content used with kind permission of Ian Forrester https://twitter.com/cubicgarden/ -->
<!-- Version 2.1 -->

<!DOCTYPE html>
<html>
  <style type="text/css" media="screen">

    #stage{background:#eee;width:300px;height:300px;overflow:hidden;
           position:relative;margin:2em 0;object-fit: cover;}
    #stage span{font-size:20px;color:#666;display:block;padding:2em;}
    video{width:400px;height:300px;position:absolute;top:0;left:0;}
    #controls{position:relative;width:400px;}
    #change{position:absolute;right:-100px;top:-300px;width:100px;}
    button{font-size:150%;text-align:center;display:block;}
    #change button{width:60px;border:none;background:#fff;}
  </style>
<head>
  <meta charset="utf-8">
  <title>Hyperaudio - BBCRD | Education | Ethics of personal data in the era of QS and IoT</title>
  <link rel="stylesheet" href="css/hyperaudio-lite-player.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.5.0/velocity.js"></script>
  <style>
    /* uncomment the following CSS for active parent / word indicator */

    .hyperaudio-transcript .active {
      background-color: #efefef;
    }

    .hyperaudio-transcript .active>.active {
      background-color: #ccf;
      text-decoration: #00f underline;
      text-decoration-thickness: 3px;
    }
  </style>
</head>

<body>
  <box style="height: 100vh;box-sizing: border-box;" id="Thebox">
  <p>
  <form id="searchForm" style="float:right;position:static;">
    <!-- comment out the following line if you don't need playback rate controls -->
    Playback Rate <span id="currentPbr">1</span><input id="pbr" type="range" value="1" min="0.5" max="3" step="0.1">
    <!-- Add a file uploader-->
    <span style="border: 1px solid #ccc; padding: 5px; margin: 5px 0" id="fileUploader">
      <label for="Uploader">Up</label>
      <input id="Uploader" type="file" accept=".json,.mp4" multiple>
    </span>
    <select id="videoRatio" onclick="changeRatio()">
      <option value="unset">Change Video Ratio</option>
      <option value="3:2">3:2</option>
      <option value="4:3">4:3</option>
      <option value="16:9">16:9</option>
      <option value="1:1">1:1</option>
      <option value="custom">Custom</option>
    </select>
    <input type="text" id="customRatio" oninput="changeRatio()" style="display: none;" placeholder="Enter ratio (e.g., 4:3)">
  </form>
  </p>
  <script>
    var debounceTimeout;
    window.addEventListener('resize', function () {
      clearTimeout(debounceTimeout);
      debounceTimeout = setTimeout(changeRatio, 100);
    });
    function changeRatio() {
      var x = document.getElementById("videoRatio").value;
      if (x === "unset") {
        return;
      }
      var y = document.getElementById("customRatio");
      var video = document.getElementById("stage");

      if (x === "custom") {
        y.style.display = "block";
      } else {
        y.style.display = "none";
        // Here you can add the logic to change the video ratio based on the selected value
        setVideoRatio(x, video);
      }

      if (y.value !== "" && x === "custom") {
        // Here you can add the logic to change the video ratio based on the manually entered value
        setVideoRatio(y.value, video);
      }
    }

    function setVideoRatio(ratio, video) {
      var [width, height] = ratio.split(':');
      var aspectRatio = height / width;
      video.style.height = `${video.offsetWidth * aspectRatio}px`;
      updateHeight();
    }
  </script>


  <script>
    function getparams() {
      var params = new URLSearchParams(window.location.search);
      var videoUrl = params.get('video');
      var subtitleUrl = params.get('subtitle');

      if (subtitleUrl) {
        fetch(subtitleUrl)
          .then(response => response.text())
          .then(content => {
            var subtitleType = subtitleUrl.substr(subtitleUrl.lastIndexOf('.'));
            switch (subtitleType) {
              case '.vtt':
                processVTT(content);
                break;
              case '.srt':
                processSRT(content);
                break;
              case '.json':
                processJSON(content);
                break;
              default:
                console.log('Unsupported subtitle format');
                break;
            }
          })
          .catch(error => console.error('Error fetching subtitle:', error));
      }

      if (videoUrl) {
        // sleep 0.5 second to wait for the subtitle to be loaded
        setTimeout(() => {
          processVideo(videoUrl);
        }, 500);
      }

      if (videoUrl && subtitleUrl) {
        // hide the file uploader
        document.getElementById('fileUploader').style.display = 'none';
      }
    };

    document.addEventListener('DOMContentLoaded', getparams());
    // window.onresize = updateHeight;

    document.getElementById('Uploader').addEventListener('change', function (e) {
      var files = Array.from(e.target.files).sort((a, b) => b.name.localeCompare(a.name));

      var videoFile, subtitleFile;
      files.forEach(file => {
        if (file.type.startsWith('video/')) {
          videoFile = file;
        } else if (['application/json', 'text/vtt', 'application/x-subrip'].includes(file.type)) {
          subtitleFile = file;
        }
      });

      if (videoFile) {
        processVideo(URL.createObjectURL(videoFile));
      }
      if (subtitleFile) {
        processSubtitles(subtitleFile);
      }
    });

    function processVideo(url) {
      // Create a new section element
      var newSection = document.createElement('section');
      newSection.setAttribute('data-media-src', url);

      // Get the article element
      var articleElement = document.querySelector('article');

      // Insert the new section at the top of the article
      articleElement.insertBefore(newSection, articleElement.firstChild);

      // Get the video element and set its src attribute
      var videoElement = document.getElementById('hyperplayer');
      videoElement.setAttribute('src', url);

      // Load the video
      videoElement.load();

      // fit height
      // setTimeout(() => {
      //   updateHeight();
      //   }, 2000);
    }

    function insertSubtitles(content) {
      // Get the first section in the article
      var articleElement = document.querySelector('article');
      var firstSection = articleElement.querySelector('section');

      // Insert the subtitles into the first section
      firstSection.innerHTML = content;

      // remove other sections
      var sections = articleElement.querySelectorAll('section');
      for (var i = 1; i < sections.length; i++) {
        sections[i].remove();
      }
    }
  
    function updateHeight() {
      let boxHeight = window.getComputedStyle(document.getElementById('Thebox')).height;
      console.log(boxHeight)
      let formHeight = window.getComputedStyle(document.getElementById('searchForm')).height;
      console.log(formHeight)
      let hyperplayerHeight = window.getComputedStyle(document.getElementById('hyperplayer')).height;
      console.log(hyperplayerHeight)

      let hypertranscriptHeight =  `${parseInt(boxHeight)- parseInt(formHeight) - parseInt(hyperplayerHeight) - 60}px`

      console.log(hypertranscriptHeight)

      document.getElementById('hypertranscript').style.height = hypertranscriptHeight;
    }
  </script>

  <!-- Comment out the following line if you are using an alternative player. ie SoundCloud or YouTube -->
  <div id="stage" >
  <video id="hyperplayer" class="hyperaudio-player" style="z-index: 5000000;"controls>
    <track id="hyperplayer-vtt" label="English" kind="subtitles" srclang="en" src="">
  </video>
</div>
<div id="controls"></div>


  <div id="hypertranscript" class="hyperaudio-transcript"
    style="overflow-y:scroll; flex: auto; min-height: 10px; height:40vh; border-style:dashed; border-width: 1px; border-color:#999; padding: 8px">

    <article data-wm="$ilp.uphold.com/123article">

      <section data-media-src="https://lab.hyperaud.io/video/BBC/education.mp4" data-wm="$ilp.uphold.com/123section">

      </section>
    </article>
  </div>

  <script src="js/hyperaudio-lite.js"></script>
  <script src="js/hyperaudio-lite-extension.js"></script>
  <script src="js/share-this.js"></script>
  <script src="js/share-this-twitter.js"></script>
  <script src="js/share-this-clipboard.js"></script>
  <script src="js/caption.js"></script>
  <script src="js/subtitle.js"></script>
  <script src="js/transformvideo.js"></script>
  <script>

    // minimizedMode is still experimental - it aims to show the current words in the title, which can be seen on the browser tab.
    let minimizedMode = false;
    let autoScroll = false;
    let doubleClick = true;
    let webMonetization = false;
    let playOnClick = true;

    // new HyperaudioLite("hypertranscript", "hyperplayer", minimizedMode, autoScroll, doubleClick, webMonetization, playOnClick);

    // Override scroll parameters
    //ht1.setScrollParameters(<duration>, <delay>, <offset>, <container>);

    // this should create captions  
    let cap1 = caption();
    cap1.init("hypertranscript", "hyperplayer", '37', '21'); // transcript Id, player Id, max chars, min chars for caption line

  </script>
  </box>
</body>

</html>